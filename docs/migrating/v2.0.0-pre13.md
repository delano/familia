# Migrating Guide: v2.0.0-pre13

This version introduces significant improvements to Familia's feature system, making it easier to organize and use features across complex projects through automatic discovery and loading of feature-specific configuration files.

## Feature-Specific Autoloading System

### Overview

The new autoloading system allows features to automatically discover and load extension files from your project directories. When you include a feature in your model, Familia now searches for configuration files using conventional patterns, enabling clean separation between core model definitions and feature-specific configurations.

### Basic Usage

#### Before (Manual Configuration)
```ruby
# app/models/user.rb
class User < Familia::Horreum
  field :name, :email, :password

  feature :safe_dump
  # All configuration had to be done in the same file
  safe_dump_fields :name, :email  # password excluded for security
end
```

#### After (Automatic Discovery)
```ruby
# app/models/user.rb - Clean model definition
class User < Familia::Horreum
  field :name, :email, :password
  feature :safe_dump  # ← Triggers autoloading
end

# app/models/user/safe_dump_extensions.rb - Automatically loaded
class User
  safe_dump_fields :name, :email  # password excluded for security
end
```

### File Naming Conventions

The autoloading system follows these patterns for discovering extension files:

#### Pattern: `{model_name}/{feature_name}_*.rb`

**Example Structures:**
```
app/models/
├── user.rb                              # Main model
├── user/
│   ├── safe_dump_extensions.rb          # SafeDump configuration
│   ├── safe_dump_custom.rb              # Additional SafeDump setup
│   └── relationships_config.rb          # Relationships configuration
├── product.rb                           # Another model
└── product/
    ├── safe_dump_fields.rb              # Product's SafeDump config
    └── expiration_settings.rb           # Expiration configuration
```

#### Supported Patterns
- `safe_dump_extensions.rb`
- `safe_dump_*.rb` (any filename starting with the feature name)
- `expiration_config.rb`
- `relationships_setup.rb`

### Advanced Configuration Examples

#### Complex SafeDump Setup
```ruby
# app/models/customer.rb
class Customer < Familia::Horreum
  field :first_name, :last_name, :email, :phone
  field :credit_card_number, :ssn, :internal_notes

  feature :safe_dump
end

# app/models/customer/safe_dump_configuration.rb
class Customer
  # Define which fields are safe for API responses
  safe_dump_fields :first_name, :last_name, :email

  # Custom serialization for specific fields
  def safe_dump_email
    email&.downcase
  end

  # Computed fields for API
  def safe_dump_full_name
    "#{first_name} #{last_name}".strip
  end
end
```

#### Multi-Feature Organization
```ruby
# app/models/session.rb
class Session < Familia::Horreum
  field :user_id, :token, :ip_address, :user_agent

  feature :safe_dump
  feature :expiration
end

# app/models/session/safe_dump_api.rb
class Session
  safe_dump_fields :user_id, :ip_address
  # token excluded for security
end

# app/models/session/expiration_policy.rb
class Session
  # Sessions expire after 24 hours
  def self.default_ttl
    24 * 60 * 60
  end

  # Cascade expiration to related data
  cascade_expiration_to :user_sessions
end
```

### Consolidated Autoloader Architecture

#### Familia::Autoloader

The new `Familia::Autoloader` class provides a shared utility for consistent file loading patterns across the framework:

```ruby
# Internal usage example (you typically won't call this directly)
autoloader = Familia::Autoloader.new(
  base_class: User,
  feature_name: :safe_dump,
  search_patterns: ['user/safe_dump_*.rb']
)

# Discovers and loads matching files
autoloader.discover_and_load_extensions
```

#### Autoloading Strategies

The autoloader supports multiple discovery strategies:

1. **Directory-based**: Search in conventional directories
2. **Pattern-based**: Use glob patterns for flexible matching
3. **Explicit paths**: Load specific files when found

### How Autoloading Works

#### Discovery Process

1. **Feature Activation**: When `feature :safe_dump` is called
2. **Path Resolution**: Autoloader determines search paths based on model location
3. **Pattern Matching**: Searches for files matching `{model_name}/{feature_name}_*.rb`
4. **File Loading**: Loads discovered files in alphabetical order
5. **Extension Application**: Feature-specific methods become available

#### Search Locations

The autoloader searches in these locations (in order):

```ruby
# If your model is in app/models/user.rb, it searches:
[
  'app/models/user/',           # Same directory as model
  'lib/user/',                  # Lib directory
  'config/models/user/',        # Config directory
  './user/'                     # Current directory
]
```

### Migration Steps

#### 1. Reorganize Existing Models

Move feature-specific configuration to separate files:

```bash
# Create directories for feature configurations
mkdir -p app/models/user
mkdir -p app/models/product
mkdir -p app/models/order

# Move configurations
# From app/models/user.rb, extract safe_dump configuration to:
# app/models/user/safe_dump_extensions.rb
```

#### 2. Update Model Files

Clean up your main model files:

```ruby
# Before: Everything in one file
class User < Familia::Horreum
  field :name, :email, :password, :role

  feature :safe_dump
  safe_dump_fields :name, :email

  feature :expiration
  def self.default_ttl
    86400
  end
end

# After: Clean separation
class User < Familia::Horreum
  field :name, :email, :password, :role

  feature :safe_dump    # Configuration auto-loaded
  feature :expiration   # Configuration auto-loaded
end
```

#### 3. Create Extension Files

Set up your feature-specific configurations:

```ruby
# app/models/user/safe_dump_extensions.rb
class User
  safe_dump_fields :name, :email
  # password and role excluded for security
end

# app/models/user/expiration_config.rb
class User
  def self.default_ttl
    86400  # 24 hours
  end
end
```

### Benefits of the New System

#### Code Organization
- **Separation of Concerns**: Feature logic separated from core model definition
- **Maintainability**: Easier to find and modify feature-specific code
- **Readability**: Core models are cleaner and more focused

#### Team Development
- **Reduced Conflicts**: Multiple developers can work on different features without merge conflicts
- **Feature Ownership**: Clear boundaries for feature-specific code
- **Testing**: Easier to test features in isolation

#### Scalability
- **Large Models**: Complex models remain manageable
- **Feature Growth**: New features can be added without bloating main model files
- **Refactoring**: Easier to extract and reorganize feature code

### Debugging Autoloading

#### Enable Debug Output

```ruby
# In your application initialization
ENV['FAMILIA_DEBUG'] = '1'

# Or programmatically
Familia::Features::Autoloadable.debug = true
```

#### Debug Output Example
```
[Familia::Autoloader] Searching for User safe_dump extensions...
[Familia::Autoloader] Found: app/models/user/safe_dump_extensions.rb
[Familia::Autoloader] Loading: app/models/user/safe_dump_extensions.rb
[Familia::Autoloader] SafeDump extension loaded successfully for User
```

#### Troubleshooting

**Common Issues:**

1. **File Not Found**: Ensure file naming follows the `{feature_name}_*.rb` pattern
2. **Load Order**: Files are loaded alphabetically; prefix with numbers if order matters
3. **Class Scope**: Extension files should reopen the same class as your model

**Validation:**
```ruby
# Check if autoloading worked
User.respond_to?(:safe_dump_field_names)  # => true
User.safe_dump_field_names                # => [:name, :email]
```

### Backward Compatibility

The autoloading system is fully backward compatible:

- **Existing Models**: Continue to work without changes
- **Manual Configuration**: Still supported alongside autoloading
- **Gradual Migration**: You can migrate models one at a time

### Performance Considerations

- **Load Time**: Files are loaded once during feature activation
- **Memory Usage**: No additional memory overhead after loading
- **Caching**: Discovered files are cached to avoid repeated filesystem scans

### Testing Your Migration

```ruby
# Test that autoloading is working
class TestUser < Familia::Horreum
  field :name, :email
  feature :safe_dump
end

# Verify extension methods are available
puts TestUser.respond_to?(:safe_dump_field_names)
puts TestUser.safe_dump_field_names.inspect

# Test instance methods
user = TestUser.new(name: "John", email: "john@example.com")
puts user.safe_dump.inspect
```

## New Capabilities

1. **Automatic Extension Discovery**: No manual require statements needed
2. **Conventional File Organization**: Standard patterns for consistent project structure
3. **Feature Isolation**: Clean separation between core models and feature configurations
4. **Shared Autoloader Infrastructure**: Consistent loading behavior across all features
5. **Debug Support**: Built-in debugging for troubleshooting autoloading issues

## Breaking Changes

**None** - This release is fully backward compatible. Existing models and feature configurations continue to work without modification.
