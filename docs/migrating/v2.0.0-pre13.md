# Migrating Guide: v2.0.0-pre13

This version introduces significant improvements to Familia's feature system and JSON performance, making it easier to organize and use features across complex projects while delivering substantial performance gains through modern JSON processing.

## Feature-Specific Autoloading System

### Overview

The new autoloading system allows features to automatically discover and load extension files from your project directories. When you include a feature in your model, Familia now searches for configuration files using conventional patterns, enabling clean separation between core model definitions and feature-specific configurations.

### Basic Usage

#### Before (Manual Configuration)
```ruby
# app/models/user.rb
class User < Familia::Horreum
  field :name, :email, :password

  feature :safe_dump
  # All configuration had to be done in the same file
  safe_dump_fields :name, :email  # password excluded for security
end
```

#### After (Automatic Discovery)
```ruby
# app/models/user.rb - Clean model definition
class User < Familia::Horreum
  field :name, :email, :password
  feature :safe_dump  # ← Triggers autoloading
end

# app/models/user/safe_dump_extensions.rb - Automatically loaded
class User
  safe_dump_fields :name, :email  # password excluded for security
end
```

### File Naming Conventions

The autoloading system follows these patterns for discovering extension files:

#### Pattern: `{model_name}/{feature_name}_*.rb`

**Example Structures:**
```
app/models/
├── user.rb                              # Main model
├── user/
│   ├── safe_dump_extensions.rb          # SafeDump configuration
│   ├── safe_dump_custom.rb              # Additional SafeDump setup
│   └── relationships_config.rb          # Relationships configuration
├── product.rb                           # Another model
└── product/
    ├── safe_dump_fields.rb              # Product's SafeDump config
    └── expiration_settings.rb           # Expiration configuration
```

#### Supported Patterns
- `safe_dump_extensions.rb`
- `safe_dump_*.rb` (any filename starting with the feature name)
- `expiration_config.rb`
- `relationships_setup.rb`

### Advanced Configuration Examples

#### Complex SafeDump Setup
```ruby
# app/models/customer.rb
class Customer < Familia::Horreum
  field :first_name, :last_name, :email, :phone
  field :credit_card_number, :ssn, :internal_notes

  feature :safe_dump
end

# app/models/customer/safe_dump_configuration.rb
class Customer
  # Define which fields are safe for API responses
  safe_dump_fields :first_name, :last_name, :email

  # Custom serialization for specific fields
  def safe_dump_email
    email&.downcase
  end

  # Computed fields for API
  def safe_dump_full_name
    "#{first_name} #{last_name}".strip
  end
end
```

#### Multi-Feature Organization
```ruby
# app/models/session.rb
class Session < Familia::Horreum
  field :user_id, :token, :ip_address, :user_agent

  feature :safe_dump
  feature :expiration
end

# app/models/session/safe_dump_api.rb
class Session
  safe_dump_fields :user_id, :ip_address
  # token excluded for security
end

# app/models/session/expiration_policy.rb
class Session
  # Sessions expire after 24 hours
  def self.default_ttl
    24 * 60 * 60
  end

  # Cascade expiration to related data
  cascade_expiration_to :user_sessions
end
```

## JSON Performance Improvements

### High-Performance JSON Processing

This version replaces Ruby's standard library JSON with the high-performance OJ gem, delivering 2-5x faster JSON operations with reduced memory allocation. The upgrade is completely transparent - all existing code continues to work without modification.

#### Automatic Benefits
- **Faster serialization**: JSON generation operations are 2-5x faster
- **Reduced memory usage**: Lower allocation during JSON processing
- **Enhanced encryption performance**: Particularly beneficial for encrypted field operations
- **Zero code changes required**: OJ configured in `mimic_JSON` mode for seamless compatibility

#### Performance Impact Examples
```ruby
# Before: Using stdlib JSON (slower)
user_data = { name: "John", email: "john@example.com" }
json_string = JSON.generate(user_data)
parsed_data = JSON.parse(json_string)

# After: Same code, 2-5x faster with OJ
user_data = { name: "John", email: "john@example.com" }
json_string = JSON.generate(user_data)  # ← Now using OJ internally
parsed_data = JSON.parse(json_string)   # ← Faster parsing
```

### Enhanced Encryption Serialization Security

#### Improved ConcealedString Handling

The encryption subsystem now provides stronger protection during JSON serialization, with enhanced `ConcealedString` behavior across different processing modes:

```ruby
# Enhanced protection for sensitive data
class User < Familia::Horreum
  field :email, :password_hash
  feature :encrypted_fields

  encrypts :password_hash
end

# ConcealedString now handles all OJ modes safely
user = User.new(email: "user@example.com", password_hash: "secret")
serialized = user.to_json  # ← Enhanced protection during serialization
```

#### New Error Handling

Added `NotSupportedError` for invalid serialization mode combinations:

```ruby
# Clear error messages for invalid configurations
begin
  # Invalid serialization mode combination
  concealed_data.serialize_with_invalid_mode
rescue Familia::NotSupportedError => e
  puts e.message  # ← Clear explanation of the issue
end
```

#### Migration Notes

**No Action Required**: All changes are backward compatible. Existing encrypted field usage continues to work with enhanced security and performance.

**Optional Verification**: If you have custom JSON serialization logic for encrypted fields, verify it works as expected with the enhanced ConcealedString handling, though compatibility is maintained.
